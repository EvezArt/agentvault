name: agentvault-nightly

on:
  schedule:
    - cron: "17 9 * * *" # daily 09:17 UTC
  workflow_dispatch: {}

permissions:
  issues: write
  contents: read

jobs:
  build-index-and-draft:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build index (no vault in Actions by default)
        run: |
          python index/build_index.py --init-only

      - name: Create or update draft queue issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = "AgentOS: Next Actions Queue (draft-only)";
            const body = [
              "This is an automated draft queue.",
              "\n\nStatus:",
              "- Index DB initialized (vault files are intentionally not available in GitHub Actions by default).",
              "- To enable full indexing, run locally or attach exports via a private runner you control.",
              "\n\nNext steps:",
              "1) Put ChatGPT export files into `vault/chatgpt/` locally.",
              "2) Put Perplexity thread exports into `vault/perplexity/`.",
              "3) Run `python index/build_index.py` locally to ingest + index.",
              "4) (Optional) Set up a self-hosted runner that has access to your vault.",
              "\n\nSafety:",
              "- Do not paste API keys into issues.",
            ].join("\n");

            const { owner, repo } = context.repo;
            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: "open", per_page: 100
            });
            const match = existing.find(i => i.title === title);

            if (match) {
              await github.rest.issues.update({ owner, repo, issue_number: match.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }
